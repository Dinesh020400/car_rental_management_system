{% extends 'base.html' %}

{% block title %}My Bookings - Car Rental System{% endblock %}

{% block content %}
<div class="row mb-5 fade-in-up">
    <div class="col-md-8">
        <h2 class="fw-bold mb-1">My Bookings</h2>
        <p class="text-muted">Manage your upcoming trips and view past rentals.</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('index') }}" class="btn btn-primary rounded-pill px-4 shadow-sm">
            <i class="fas fa-plus me-2"></i>Book New Car
        </a>
    </div>
</div>

{% if bookings %}
<!-- Stats Section -->
<div class="row g-4 mb-5 fade-in-up" style="animation-delay: 0.1s;">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm overflow-hidden h-100">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-uppercase fw-bold text-muted small mb-0">Total Bookings</h6>
                    <span class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle p-2">
                        <i class="fas fa-calendar-check fa-lg"></i>
                    </span>
                </div>
                <h2 class="display-6 fw-bold mb-0 text-dark">{{ bookings|length }}</h2>
            </div>
            <div class="bg-primary h-1 w-100" style="height: 4px;"></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm overflow-hidden h-100">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-uppercase fw-bold text-muted small mb-0">Confirmed</h6>
                    <span class="icon-box bg-success bg-opacity-10 text-success rounded-circle p-2">
                        <i class="fas fa-check-circle fa-lg"></i>
                    </span>
                </div>
                <h2 class="display-6 fw-bold mb-0 text-dark">{{ bookings|selectattr('status', 'equalto',
                    'confirmed')|list|length }}</h2>
            </div>
            <div class="bg-success h-1 w-100" style="height: 4px;"></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm overflow-hidden h-100">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-uppercase fw-bold text-muted small mb-0">Cancelled</h6>
                    <span class="icon-box bg-danger bg-opacity-10 text-danger rounded-circle p-2">
                        <i class="fas fa-times-circle fa-lg"></i>
                    </span>
                </div>
                <h2 class="display-6 fw-bold mb-0 text-dark">{{ bookings|selectattr('status', 'equalto',
                    'cancelled')|list|length }}</h2>
            </div>
            <div class="bg-danger h-1 w-100" style="height: 4px;"></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm overflow-hidden h-100">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-uppercase fw-bold text-muted small mb-0">Total Spent</h6>
                    <span class="icon-box bg-info bg-opacity-10 text-info rounded-circle p-2">
                        <i class="fas fa-wallet fa-lg"></i>
                    </span>
                </div>
                <h2 class="display-6 fw-bold mb-0 text-dark">₹{{ bookings|selectattr('status', 'equalto',
                    'confirmed')|sum(attribute='total_price')|round(0)|int }}</h2>
            </div>
            <div class="bg-info h-1 w-100" style="height: 4px;"></div>
        </div>
    </div>
</div>

<!-- Bookings List -->
<div class="d-flex flex-column gap-3 mb-5 fade-in-up" style="animation-delay: 0.2s;">
    {% for booking in bookings %}
    <div class="card border-0 shadow-sm overflow-hidden transition-hover">
        <div class="card-body p-0">
            <div class="row g-0">
                <!-- Car Image (Left) -->
                <div class="col-md-3 position-relative">
                    {% if booking.car %}
                    <img src="/static/car_images/{{ booking.car.image.split('/')[-1] if booking.car.image else 'default_car.jpg' }}"
                        class="w-100 h-100 object-fit-cover" style="min-height: 180px; object-fit: cover;"
                        alt="{{ booking.car.make }}">
                    <div class="position-absolute top-0 start-0 m-3 d-md-none">
                        <span
                            class="badge {% if booking.status == 'confirmed' %}bg-success{% elif booking.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </div>
                    {% else %}
                    <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center text-muted"
                        style="min-height: 180px;">
                        <i class="fas fa-car-crash fa-2x"></i>
                    </div>
                    {% endif %}
                </div>

                <!-- Booking Details (Right) -->
                <div class="col-md-9">
                    <div class="p-4 d-flex flex-column h-100 justify-content-center">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                {% if booking.car %}
                                <h4 class="fw-bold mb-1">{{ booking.car.make }} {{ booking.car.model }}</h4>
                                <p class="text-muted mb-0">{{ booking.car.year }} Model</p>
                                {% else %}
                                <h4 class="fw-bold text-danger mb-1">Car Removed</h4>
                                <p class="text-muted mb-0">This vehicle is no longer in our fleet.</p>
                                {% endif %}
                            </div>
                            <div class="text-end d-none d-md-block">
                                <span
                                    class="badge {% if booking.status == 'confirmed' %}bg-success{% elif booking.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %} px-3 py-2 rounded-pill">
                                    {{ booking.status|title }}
                                </span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6 col-lg-4">
                                <div class="p-2 border rounded bg-light">
                                    <small class="text-muted d-block fw-bold text-uppercase"
                                        style="font-size: 0.7rem;">Pick-up Date</small>
                                    <span class="text-dark fw-bold"><i
                                            class="fas fa-calendar-alt me-2 text-primary"></i>{{ booking.start_date
                                        }}</span>
                                </div>
                            </div>
                            <div class="col-6 col-lg-4">
                                <div class="p-2 border rounded bg-light">
                                    <small class="text-muted d-block fw-bold text-uppercase"
                                        style="font-size: 0.7rem;">Return Date</small>
                                    <span class="text-dark fw-bold"><i
                                            class="fas fa-calendar-check me-2 text-primary"></i>{{ booking.end_date
                                        }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div
                                    class="p-2 border rounded bg-light d-flex align-items-center justify-content-between">
                                    <div>
                                        <small class="text-muted d-block fw-bold text-uppercase"
                                            style="font-size: 0.7rem;">Total Price</small>
                                        <span class="text-primary fw-bold fs-5">₹{{ booking.total_price }}</span>
                                    </div>
                                    <span class="badge bg-white text-dark border">{{ booking.total_days }} Days</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-auto">
                            {% if booking.car %}
                            <a href="{{ url_for('car_details', car_id=booking.car.id) }}"
                                class="btn btn-outline-primary btn-sm fw-bold">
                                View Details
                            </a>
                            {% endif %}

                            {% if booking.status == 'confirmed' %}
                            <a href="{{ url_for('cancel_booking', booking_id=booking.id) }}"
                                class="btn btn-outline-danger btn-sm fw-bold"
                                onclick="return confirm('Are you sure you want to cancel this booking?');">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            {% elif booking.status == 'completed' %}
                            <a href="{{ url_for('add_review', booking_id=booking.id) }}"
                                class="btn btn-warning btn-sm fw-bold text-white">
                                <i class="fas fa-star me-1"></i>Write Review
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="text-center py-5 fade-in-up">
    <div class="mb-4">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
            style="width: 100px; height: 100px;">
            <i class="fas fa-clipboard-list fa-3x text-muted"></i>
        </div>
    </div>
    <h3 class="fw-bold text-dark">No Bookings Yet</h3>
    <p class="text-muted mb-4">You haven't made any reservations. It's time to start your journey!</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg">
        Explore Vehicles
    </a>
</div>
{% endif %}

{% endblock %}